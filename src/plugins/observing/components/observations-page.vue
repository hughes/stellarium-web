// Stellarium Web - Copyright (c) 2018 - Noctua Software Ltd
//
// This program is licensed under the terms of the GNU AGPL v3, or
// alternatively under a commercial licence.
//
// The terms of the AGPL v3 license can be found in the main directory of this
// repository.

<template>
<observing-panel-page>

  <div slot="main_page" class="scroll-container">
    <v-container fluid style="height: 100%">
      <div v-if="$store.state.plugins.observing.noctuaSky.status !== 'loggedIn'" style="text-align: center; margin-bottom: 15px; color: red;">Warning: you are not logged in, you can add and edit observations, but they all will be suppressed if you leave the page, or login with your account.</div>
      <v-layout row wrap>
        <v-flex xs12 v-for="obsg in observationGroups" :key="obsg.f1[0].id">
          <grouped-observations :obsGroupData="obsg" @thumbClicked="thumbClicked"></grouped-observations>
        </v-flex>
      </v-layout>
      <div v-if="showEmptyMessage" style="margin-top: 40vh; text-align: center;">Nothing here yet..<br>Add new observations by clicking on the + button below</div>
      <v-layout row wrap>
        <v-btn fab dark absolute color="pink" bottom right class="pink" slot="activator" style="bottom: 16px; margin-right: 10px" @click.stop.native="showObservationDetailsPage()">
          <v-icon dark>add</v-icon>
        </v-btn>
          <v-tooltip left>
            <span>Log a new Observation</span>
          </v-tooltip>
      </v-layout>
    </v-container>
  </div>

  <template slot="sub_pages">
    <v-tab-item key="3" style="height: 100%">
      <observation-details @back="backFromObservationDetails()" v-model="observationToAdd" :create="createObservation"></observation-details>
    </v-tab-item>
  </template>

</observing-panel-page>
</template>

<script>
import GroupedObservations from './grouped-observations.vue'
import ObservationDetails from './observation-details.vue'
import ObservingPanelPage from '@/components/observing-panel-page.vue'
import NoctuaSkyClient from '@/assets/noctuasky-client'
import { swh } from '@/assets/sw_helpers.js'

export default {
  data: function () {
    return {
      observationToAdd: undefined,
      createObservation: false,
      savedViewSettings: []
    }
  },
  created: function () {
    let that = this
    swh.selectedObjectExtraButtons.push({
      id: 'observe',
      name: 'Observe',
      icon: 'add',
      callback: function (b) {
        that.$store.commit('setValue', {varName: 'showObservingPanel', newValue: true})
        that.$store.commit('setValue', {varName: 'observingPanelCurrentComponent', newValue: 'observations-page'})
        that.showObservationDetailsPage()
      }
    })
  },
  methods: {
    saveViewSettings: function () {
      this.savedViewSettings['utc'] = this.$store.state.stel.observer.utc
      this.savedViewSettings['loc'] = this.$store.state.currentLocation
      this.savedViewSettings['azalt'] = this.$store.state.stel.observer.azalt
      this.savedViewSettings['fov'] = this.$store.state.stel.fov
      this.savedViewSettings['lock'] = this.$stel.core.lock
    },
    restoreViewSettings: function () {
      if (!this.savedViewSettings) return
      if (this.savedViewSettings.utc) this.$stel.core.observer.utc = this.savedViewSettings.utc
      if (this.savedViewSettings.loc) {
        let loc = this.savedViewSettings.loc
        this.$stel.core.observer.latitude = loc.lat * Math.PI / 180.0
        this.$stel.core.observer.longitude = loc.lng * Math.PI / 180.0
        this.$stel.core.observer.elevation = loc.alt
        this.$store.commit('setCurrentLocation', loc)
      }
      if (this.savedViewSettings.lock) this.$stel.core.lock = this.savedViewSettings.lock
      if (this.savedViewSettings.azalt && this.savedViewSettings.fov) this.$stel.core.lookat(this.savedViewSettings.azalt, 1.0, this.savedViewSettings.fov)
    },
    backFromObservationDetails: function () {
      this.restoreViewSettings()
      this.active = '0'
    },
    thumbClicked: function (obs) {
      this.saveViewSettings()
      this.createObservation = false
      // Use assign to force triggering the reactive event
      this.observationToAdd = Object.assign({}, obs)
      this.active = '3'
    },
    showObservationDetailsPage: function () {
      // Set this to default values
      let obs = this.getDefaultObservation()
      let lastModified = NoctuaSkyClient.observations.lastModified()
      if (lastModified) {
        obs.mjd = lastModified.mjd
        obs.location = NoctuaSkyClient.locations.get(lastModified.location)
        obs.observingSetup = lastModified.observingSetup
      }
      this.saveViewSettings()
      this.observationToAdd = Object.assign({}, obs)
      this.createObservation = true
      this.active = '3'
    },
    editNewObservationFromSelection: function () {
      let obs = this.getDefaultObservation()
      let lastModified = NoctuaSkyClient.observations.lastModified()
      if (lastModified) {
        obs.observingSetup = lastModified.observingSetup
      }
      this.saveViewSettings()
      this.observationToAdd = Object.assign({}, obs)
      this.createObservation = true
      this.active = '3'
    },
    getDefaultObservation: function () {
      let res = {
        target: undefined,
        mjd: this.$store.state.stel.observer.utc,
        location: this.$store.state.currentLocation,
        difficulty: 0,
        rating: 0,
        comment: '',
        observingSetup: {
          'id': 'eyes_observation',
          'state': {}
        }
      }
      if (this.$store.state.selectedObject) {
        res.target = this.$store.state.selectedObject
      }
      return res
    }
  },
  computed: {
    showEmptyMessage: function () {
      return this.observationGroups.length === 0
    },
    observationGroups: function () {
      var aggregator = [
        { $group: { id: { location: '$location', julian_day: { $floor: '$mjd' } }, groupDate: { min: { $min: '$mjd' }, max: { $max: '$mjd' } }, f0: { $sum: 1 }, f1: { $push: '$$ROOT' } } },
        { $sort: { 'groupDate.max': -1 } }
      ]
      return NoctuaSkyClient.observations.aggregate(aggregator)
    }
  },
  components: { GroupedObservations, ObservationDetails, ObservingPanelPage }
}
</script>

<style>
.scroll-container {
  height: calc(100% - 48px);
  overflow-y: auto;
  backface-visibility: hidden;
}
</style>
